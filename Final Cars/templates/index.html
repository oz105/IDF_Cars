<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">



    <meta charset="UTF-8" />
    <title>מעקב רכבים</title>
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="position-fixed top-0 start-50 translate-middle-x mt-4" style="z-index: 1055;">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show shadow rounded" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    <h1>מערכת מעקב רכבים</h1>

    <form action="{{ url_for('logout') }}" method="get" style="margin: 0; padding: 0;">
        <button type="submit" class="logout-btn">התנתק</button>
    </form>

    <div class="main-container">
        <!-- צד שמאל: רשימות תזכורות -->
        <div class="reminder-lists">
            <section>
                <h2>3 רכבים עם טיפול רגיל הכי קרוב</h2>
                <ul>
                    {% for car in closest_maintenance %}
                    <li>
                        <strong>{{ car.license_plate }} - {{ car.car_model }}</strong>
                        <span>טיפול הבא: {{ car.next_maintenance_date }}</span>
                        <a href="{{ url_for('send_reminder', license_plate=car.license_plate, type='maintenance') }}" class="btn btn-outline-primary btn-sm ms-2">
                            שלח תזכורת לטיפול רגיל
                        </a>
                    </li>
                    {% else %}
                    <li>אין נתונים זמינים</li>
                    {% endfor %}
                </ul>
            </section>

            <section>
                <h2>3 רכבים עם טיפול שמנים הכי קרוב</h2>
                <ul>
                    {% if closest_oil %}
                        {% for car in closest_oil %}
                        <li>
                            <strong>{{ car.license_plate }} - {{ car.car_model }}</strong>
                            <span>טיפול שמנים: {{ car.oil_change_date }}</span>
                            <a href="{{ url_for('send_reminder', license_plate=car.license_plate, type='oil') }}" class="btn btn-outline-warning btn-sm ms-2">
                                שלח תזכורת לטיפול שמנים
                            </a>
                        </li>
                        {% endfor %}
                    {% else %}
                        <li>אין נתונים זמינים</li>
                    {% endif %}
                </ul>
            </section>

            <section>
                <h2>3 רכבים עם תוקף טסט הכי קרוב</h2>
                <ul>
                    {% for car in closest_test %}
                    <li>
                        <strong>{{ car.license_plate }} - {{ car.car_model }}</strong>
                        <span>תוקף טסט: {{ car.test_due_date }}</span>
                        <a href="{{ url_for('send_reminder', license_plate=car.license_plate, type='test') }}" class="btn btn-outline-success btn-sm ms-2">
                            שלח תזכורת לטסט
                        </a>
                    </li>
                    {% else %}
                    <li>אין נתונים זמינים</li>
                    {% endfor %}
                </ul>
            </section>
        </div>

        <!-- צד ימין: טופס הוספת רכב -->
        <div class="form-container">
            <form method="post" action="/add" class="compact-form">
                <label for="license_plate">מספר רישוי:</label>
                <input type="text" id="license_plate" name="license_plate" required>

                <label for="car_model">דגם:</label>
                <input type="text" id="car_model" name="car_model" required>

                <label for="ownership">בעלות:</label>
                <input type="text" id="ownership" name="ownership" placeholder="לדוגמה: שׁכור">

                <label for="status">סטטוס:</label>
                <input type="text" id="status" name="status" placeholder="לדוגמה: כשיר">

                <label for="year">שנת יצור:</label>
                <input type="number" id="year" name="year" min="1900" max="2100">

                <label for="last_service_km">ק״מ טיפול אחרון:</label>
                <input type="number" id="last_service_km" name="last_service_km" min="0">

                <label for="next_service_km">ק״מ טיפול הבא:</label>
                <input type="number" id="next_service_km" name="next_service_km" min="0">

                <label for="test_due_date">תוקף טסט:</label>
                <input type="date" id="test_due_date" name="test_due_date">

                <label for="next_maintenance_date">תאריך טיפול הבא:</label>
                <input type="date" id="next_maintenance_date" name="next_maintenance_date">

                <label for="oil_change_date">תאריך טיפול שמנים:</label>
                <input type="date" id="oil_change_date" name="oil_change_date">

                <label for="km">ק״מ נוכחי:</label>
                <input type="number" id="km" name="km" min="0" required>

                <button type="submit" class="btn-small">הוסף רכב</button>
            </form>
        </div>
    </div>

    <h2>מאגר כל הרכבים</h2>
    <table>
        <thead>
            <tr>
                <th>מספר רישוי</th>
                <th>דגם</th>
                <th>בעלות</th>
                <th>סטטוס</th>
                <th>שנת יצור</th>
                <th>תאריך טיפול אחרון</th>
                <th>תוקף טסט</th>
                <th>תאריך טיפול הבא</th>
                <th>תאריך טיפול שמנים</th>
                <th>ק"מ נוכחי</th>
                <th class="text-center">🗑️</th>
            </tr>
        </thead>
        <tbody>
    {% for car in cars %}
    <tr>
        <td>
            <img src="{{ url_for('static', filename='images/car.png') }}" alt="Car" style="width: 25px; vertical-align: middle; margin-left: 6px;">
            {{ car.license_plate }}
        </td>
        <td>{{ car.car_model }}</td>
        <td>{{ car.ownership or '-' }}</td>
        <td>{{ car.status or '-' }}</td>
        <td>{{ car.year or '-' }}</td>
        <td>
            {{ car.last_maintenance_date or '-' }}
            {% if car.last_maintenance_details %}
            <div class="text-center mt-2">
                <a href="{{ url_for('maintenance_details', license_plate=car.license_plate) }}" class="btn btn-warning btn-sm">
                    🛠️ פירוט טיפול
                </a>
            </div>
            {% endif %}
        </td>
        <td>{{ car.test_due_date or '-' }}</td>
        <td>{{ car.next_maintenance_date or '-' }}</td>
        <td>{{ car.oil_change_date or '-' }}</td>
        <td>
            {{ car.km }}
            <div class="text-center mt-2">
                <a href="{{ url_for('send_km_request', license_plate=car.license_plate) }}" class="btn btn-warning btn-sm">
                    📤 בקש עדכון ק"מ
                </a>
            </div>
        </td>
        <!-- כפתור מחיקה -->
        <td class="text-center">
            <form action="{{ url_for('delete_car', license_plate=car.license_plate) }}" method="post"
                  onsubmit="return confirm('האם אתה בטוח שברצונך למחוק את הרכב?');">
                <button type="submit" class="btn btn-sm btn-danger" title="מחק רכב">
                    <i class="fas fa-trash"></i>
                </button>
            </form>
        </td>
    </tr>
    {% endfor %}
</tbody>

    </table>

    <div class="update-links">
        <a href="{{ url_for('update_km') }}">עדכן ק"מ</a>
        <a href="{{ url_for('update_test') }}">עדכן תוקף טסט</a>
        <a href="{{ url_for('update_maintenance') }}">עדכן תאריכי טיפול</a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
          setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
          }, 4000);
        });
      });
    </script>

</body>
</html>
